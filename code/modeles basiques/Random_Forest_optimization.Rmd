---
title: "GLM optimization"
author: "AKROUT Leyth, BOULAHFA Jawad, DE SANTIAGO Kylliann"
date: "22 février 2021"
output:
  prettydoc::html_pretty:
    toc: true
    theme: cayman
    highlight: github
    df_print: paged
---

```{r, echo=FALSE}
rm(list = ls())
```

```{r}
#load(file = "GLM_optimization_final_version.Rdata")
#rm(model_gamma_reactivity, model_gamma_reactivity_pen_ridge, model_gamma_reactivity_pen_enet,
#   model_gamma_deg_Mg_pH10, model_gamma_deg_Mg_pH10_pen_ridge, model_gamma_deg_Mg_pH10_pen_enet,
#   model_gamma_deg_pH10, model_gamma_deg_pH10_pen_ridge, model_gamma_deg_pH10_pen_enet,
#   model_gamma_deg_Mg_50C, model_gamma_deg_Mg_50C_pen_ridge, model_gamma_deg_Mg_50C_pen_enet,
#   model_gamma_deg_50C, model_gamma_deg_50C_pen_ridge, model_gamma_deg_50C_pen_enet)
```


```{r, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(caret)
library(MASS)
library(doParallel) # calcul parallèle
library(glmnet)
library(randomForest)
# source("~/suivi-du-data-camp-DeSantiago_Boulahfa_Akrout/code/projet_fct.R")
source("C:/Users/Startklar/suivi-du-data-camp-DeSantiago_Boulahfa_Akrout/code/projet_fct.R")
# source("./projet_fct.R")
```

```{r}
set.seed(1)
```

# Chargement et réorganisation des données

Chargement du jeu de données.
```{r}
# data = read.csv("~/suivi-du-data-camp-DeSantiago_Boulahfa_Akrout/code/data_train.csv")
data = read.csv("data_train.csv")
head(data) # une colonne en trop
data = data[,-1]
head(data)
```

On change les types des variables qui sont mal codées.
```{r}
data=data %>% mutate(sequence = as.factor(sequence)) %>% 
  mutate(seq_be = as.factor(seq_be)) %>% 
  mutate(seq_af = as.factor(seq_af)) %>% 
  mutate(sequence = as.factor(sequence)) %>% 
  mutate(structure = as.factor(structure)) %>%
  mutate(struct_be = as.factor(struct_be)) %>% 
  mutate(struct_af = as.factor(struct_af)) %>% 
  mutate(predicted_loop_type = as.factor(predicted_loop_type)) %>% 
  mutate(loop_type_be = as.factor(loop_type_be)) %>% 
  mutate(loop_type_af = as.factor(loop_type_af)) 
```

```{r}
length_sequence_train <- 68
```

On filtre maintenant les données qui ont SN_filter=0.
```{r}
print(sum(is.na(data)))
print(sum(data$SN_filter==0)/length_sequence_train) # Nombre d'individus dont le SN_filter=0
data=data[data$SN_filter==1,]
rownames(data)=NULL#1:108052
```

Plutôt que mettre à 0 les valeurs négatives, on va effectuer une translation sur chaque label en soustrayant chacune de ses valeurs par la valeur minimale du label puis en ajoutant un bruit afin de se placer sur $\mathbb{R}_+^*$.
```{r}
p = dim(data)[2]
bruit = 1e-12
```

Initialement, il existe des valeurs négatives pour nos labels mais cela ne pose pas de problème pour construire des modèles Random Forest. On n'a donc pas besoin de translater les labels ici.
```{r}
sum(data$reactivity <= 0)
sum(data$deg_50C <= 0)
sum(data$deg_Mg_50C <= 0)
sum(data$deg_pH10 <= 0)
sum(data$deg_Mg_pH10 <= 0)
```

# Création de la base train/validation

```{r}
tamp=train_test_split(data)
index_train = tamp$index_train

data_train=tamp$train
rownames(data_train) <- NULL

data_val=tamp$val
rownames(data_val) <- NULL
```

```{r}
sum(is.na(data_train))
sum(is.na(data_val))
dim(data_train)[1]+dim(data_val)[1]-dim(data)[1]
```

```{r}
#rm(tamp,data)
```

# Random Forest

## Premiers essais

Formule du modèle initial utilisé.
```{r}
formula_model_RF <- "reactivity ~ sequence + index_sequence + structure + predicted_loop_type + seq_be + seq_af + struct_be + struct_af + loop_type_be + loop_type_af"
print(formula_model_RF)
```

```{r}
names_coef <- c("(Intercept)", "(Intercept)_", "sequenceC", "sequenceG", "sequenceU",
                "index_sequence", "structure)", "structure.",
                "predicted_loop_typeE", "predicted_loop_typeH", "predicted_loop_typeI",
                "predicted_loop_typeM", "predicted_loop_typeS", "predicted_loop_typeX",
                "seq_beC", "seq_beG", "seq_beO", "seq_beU",
                "seq_afC", "seq_afG", "seq_afO", "seq_afU",
                "struct_be)", "struct_be.", "struct_beO",
                "struct_af)", "struct_af.", "struct_afO",
                "loop_type_beE", "loop_type_beH", "loop_type_beI", "loop_type_beM",
                "loop_type_beO", "loop_type_beS", "loop_type_beX",
                "loop_type_afE", "loop_type_afH", "loop_type_afI", "loop_type_afM",
                "loop_type_afO", "loop_type_afS", "loop_type_afX"
                )
for(i in 0:106)
{
  names_coef <- c(names_coef, paste0("bpps_", i))
}
#print(names_coef)
```

```{r}
names_coef[43] # le premier bpps est à la 43ème position du vecteur
```

```{r}
models_RF <- c()
errors_RF_train <- c()
errors_RF_val <- c()
```

### Reactivity

On charge le modèle lasso utilisé précédemment.
```{r}
model_gamma_reactivity_pen_lasso <- readRDS("model_gamma_reactivity_pen_lasso.rds")
```

```{r}
lasso_reactivity_coef <-
  data.frame(matrix(coef(model_gamma_reactivity_pen_lasso, s = 'lambda.min')))
colnames(lasso_reactivity_coef) <- "Coefficients"
rownames(lasso_reactivity_coef) <- names_coef
```

```{r}
zeros_reactivity <- which(apply(lasso_reactivity_coef, 2, function(x) x == 0))
```

On va garder uniquement les bpps retenus par la modèle lasso vu précédemment pour construire notre modèle Random Forest.
```{r}
formula_model_RF_reactivity <- formula_model_RF
for(i in 0:106)
{
  index_bbps_i <- i + 43
  if(!(index_bbps_i %in% zeros_reactivity)) # Si le bpps i n'a pas un coefficient nul dans le lasso
  {
    formula_model_RF_reactivity <- paste0(formula_model_RF_reactivity, " + bpps_", i)
  }
}
print(formula_model_RF_reactivity)
```

```{r}
model_RF_reactivity = randomForest(formula = as.formula(formula_model_RF_reactivity),
                                   data = data_train,
                                   method = "anova",
                                   nodesize = 10,
                                   ntree=3)
```

```{r}
summary(model_RF_reactivity)
```

```{r}
y_pred_RF_train = predict(model_RF_reactivity,data_train,type="response")
error_RF_train <- mean((y_pred_RF_train-data_train$reactivity)^2,na.rm=TRUE)
print(error_RF_train)

y_pred_RF_val=predict(model_RF_reactivity,data_val,type="response")
error_RF_val <- mean((y_pred_RF_val-data_val$reactivity)^2,na.rm=TRUE)
print(error_RF_val)
```

```{r}
models_RF <- c(models_RF, "reactivity")
errors_RF_train <- c(errors_RF_train, error_RF_train)
errors_RF_val <- c(errors_RF_val, error_RF_val)
```


### deg_Mg_pH10

On charge le modèle lasso utilisé précédemment.
```{r}
model_gamma_deg_Mg_pH10_pen_lasso <- readRDS("model_gamma_deg_Mg_pH10_pen_lasso.rds")
```

```{r}
lasso_deg_Mg_pH10_coef <-
  data.frame(matrix(coef(model_gamma_deg_Mg_pH10_pen_lasso, s = 'lambda.min')))
colnames(lasso_deg_Mg_pH10_coef) <- "Coefficients"
rownames(lasso_deg_Mg_pH10_coef) <- names_coef
```

```{r}
zeros_deg_Mg_pH10 <- which(apply(lasso_deg_Mg_pH10_coef, 2, function(x) x == 0))
```

On va garder uniquement les bpps retenus par la modèle lasso vu précédemment pour construire notre modèle Random Forest.
```{r}
formula_model_RF_deg_Mg_pH10 <- formula_model_RF
for(i in 0:106)
{
  index_bbps_i <- i + 43
  if(!(index_bbps_i %in% zeros_deg_Mg_pH10)) # Si le bpps i n'a pas un coefficient nul dans le lasso
  {
    formula_model_RF_deg_Mg_pH10 <- paste0(formula_model_RF_deg_Mg_pH10, " + bpps_", i)
  }
}
print(formula_model_RF_deg_Mg_pH10)
```

```{r}
model_RF_deg_Mg_pH10 = randomForest(formula = as.formula(formula_model_RF_deg_Mg_pH10),
                                    data = data_train,
                                    method = "anova",
                                    nodesize = 10,
                                    ntree=3)
```

```{r}
summary(model_RF_deg_Mg_pH10)
```

```{r}
y_pred_RF_train = predict(model_RF_deg_Mg_pH10,data_train,type="response")
error_RF_train <- mean((y_pred_RF_train-data_train$deg_Mg_pH10)^2,na.rm=TRUE)
print(error_RF_train)

y_pred_RF_val=predict(model_RF_deg_Mg_pH10,data_val,type="response")
error_RF_val <- mean((y_pred_RF_val-data_val$deg_Mg_pH10)^2,na.rm=TRUE)
print(error_RF_val)
```


```{r}
models_RF <- c(models_RF, "deg_Mg_pH10")
errors_RF_train <- c(errors_RF_train, error_RF_train)
errors_RF_val <- c(errors_RF_val, error_RF_val)
```

### deg_pH10


On charge le modèle lasso utilisé précédemment.
```{r}
model_gamma_deg_pH10_pen_lasso <- readRDS("model_gamma_deg_pH10_pen_lasso.rds")
```

```{r}
lasso_deg_pH10_coef <-
  data.frame(matrix(coef(model_gamma_deg_pH10_pen_lasso, s = 'lambda.min')))
colnames(lasso_deg_pH10_coef) <- "Coefficients"
rownames(lasso_deg_pH10_coef) <- names_coef
```

```{r}
zeros_deg_pH10 <- which(apply(lasso_deg_pH10_coef, 2, function(x) x == 0))
```

On va garder uniquement les bpps retenus par la modèle lasso vu précédemment pour construire notre modèle Random Forest.
```{r}
formula_model_RF_deg_pH10 <- formula_model_RF
for(i in 0:106)
{
  index_bbps_i <- i + 43
  if(!(index_bbps_i %in% zeros_deg_pH10)) # Si le bpps i n'a pas un coefficient nul dans le lasso
  {
    formula_model_RF_deg_pH10 <- paste0(formula_model_RF_deg_pH10, " + bpps_", i)
  }
}
print(formula_model_RF_deg_pH10)
```

```{r}
model_RF_deg_pH10 = randomForest(formula = as.formula(formula_model_RF_deg_pH10),
                                    data = data_train,
                                    method = "anova",
                                    nodesize = 10,
                                    ntree=3)
```

```{r}
summary(model_RF_deg_pH10)
```

```{r}
y_pred_RF_train = predict(model_RF_deg_pH10,data_train,type="response")
error_RF_train <- mean((y_pred_RF_train-data_train$deg_pH10)^2,na.rm=TRUE)
print(error_RF_train)

y_pred_RF_val=predict(model_RF_deg_pH10,data_val,type="response")
error_RF_val <- mean((y_pred_RF_val-data_val$deg_pH10)^2,na.rm=TRUE)
print(error_RF_val)
```

```{r}
models_RF <- c(models_RF, "deg_pH10")
errors_RF_train <- c(errors_RF_train, error_RF_train)
errors_RF_val <- c(errors_RF_val, error_RF_val)
```

### deg_Mg_50C


On charge le modèle lasso utilisé précédemment.
```{r}
model_gamma_deg_Mg_50C_pen_lasso <- readRDS("model_gamma_deg_Mg_50C_pen_lasso.rds")
```

```{r}
lasso_deg_Mg_50C_coef <-
  data.frame(matrix(coef(model_gamma_deg_Mg_50C_pen_lasso, s = 'lambda.min')))
colnames(lasso_deg_Mg_50C_coef) <- "Coefficients"
rownames(lasso_deg_Mg_50C_coef) <- names_coef
```

```{r}
zeros_deg_Mg_50C <- which(apply(lasso_deg_Mg_50C_coef, 2, function(x) x == 0))
```

On va garder uniquement les bpps retenus par la modèle lasso vu précédemment pour construire notre modèle Random Forest.
```{r}
formula_model_RF_deg_Mg_50C <- formula_model_RF
for(i in 0:106)
{
  index_bbps_i <- i + 43
  if(!(index_bbps_i %in% zeros_deg_Mg_50C)) # Si le bpps i n'a pas un coefficient nul dans le lasso
  {
    formula_model_RF_deg_Mg_50C <- paste0(formula_model_RF_deg_Mg_50C, " + bpps_", i)
  }
}
print(formula_model_RF_deg_Mg_50C)
```


```{r}
model_RF_deg_Mg_50C = randomForest(formula = as.formula(formula_model_RF_deg_Mg_50C),
                                    data = data_train,
                                    method = "anova",
                                    nodesize = 10,
                                    ntree=3)
```

```{r}
summary(model_RF_deg_Mg_50C)
```

```{r}
y_pred_RF_train = predict(model_RF_deg_Mg_50C,data_train,type="response")
error_RF_train <- mean((y_pred_RF_train-data_train$deg_Mg_50C)^2,na.rm=TRUE)
print(error_RF_train)

y_pred_RF_val=predict(model_RF_deg_Mg_50C,data_val,type="response")
error_RF_val <- mean((y_pred_RF_val-data_val$deg_Mg_50C)^2,na.rm=TRUE)
print(error_RF_val)
```

```{r}
models_RF <- c(models_RF, "deg_Mg_50C")
errors_RF_train <- c(errors_RF_train, error_RF_train)
errors_RF_val <- c(errors_RF_val, error_RF_val)
```

### deg_50C


On charge le modèle lasso utilisé précédemment.
```{r}
model_gamma_deg_50C_pen_lasso <- readRDS("model_gamma_deg_50C_pen_lasso.rds")
```

```{r}
lasso_deg_50C_coef <-
  data.frame(matrix(coef(model_gamma_deg_50C_pen_lasso, s = 'lambda.min')))
colnames(lasso_deg_50C_coef) <- "Coefficients"
rownames(lasso_deg_50C_coef) <- names_coef
```

```{r}
zeros_deg_50C <- which(apply(lasso_deg_50C_coef, 2, function(x) x == 0))
```

On va garder uniquement les bpps retenus par la modèle lasso vu précédemment pour construire notre modèle Random Forest.
```{r}
formula_model_RF_deg_50C <- formula_model_RF
for(i in 0:106)
{
  index_bbps_i <- i + 43
  if(!(index_bbps_i %in% zeros_deg_50C)) # Si le bpps i n'a pas un coefficient nul dans le lasso
  {
    formula_model_RF_deg_50C <- paste0(formula_model_RF_deg_50C, " + bpps_", i)
  }
}
print(formula_model_RF_deg_50C)
```

```{r}
model_RF_deg_50C = randomForest(formula = as.formula(formula_model_RF_deg_50C),
                                    data = data_train,
                                    method = "anova",
                                    nodesize = 10,
                                    ntree=3)
```

```{r}
summary(model_RF_deg_Mg_50C)
```

```{r}
y_pred_RF_train = predict(model_RF_deg_50C,data_train,type="response")
error_RF_train <- mean((y_pred_RF_train-data_train$deg_50C)^2,na.rm=TRUE)
print(error_RF_train)

y_pred_RF_val=predict(model_RF_deg_50C,data_val,type="response")
error_RF_val <- mean((y_pred_RF_val-data_val$deg_50C)^2,na.rm=TRUE)
print(error_RF_val)
```

```{r}
models_RF <- c(models_RF, "deg_50C")
errors_RF_train <- c(errors_RF_train, error_RF_train)
errors_RF_val <- c(errors_RF_val, error_RF_val)
```

### Récapitulatif des résultats

```{r}
saveRDS(model_RF_reactivity, file = "model_RF_reactivity.rds")
saveRDS(model_RF_deg_Mg_pH10, file = "model_RF_deg_Mg_pH10.rds")
saveRDS(model_RF_deg_pH10, file = "model_RF_deg_pH10.rds")
saveRDS(model_RF_deg_Mg_50C, file = "model_RF_deg_Mg_50C.rds")
saveRDS(model_RF_deg_50C, file = "model_RF_deg_50C.rds")

loadRDS(file = "model_RF_reactivity.rds")
loadRDS(file = "model_RF_deg_Mg_pH10.rds")
loadRDS(file = "model_RF_deg_pH10.rds")
loadRDS(file = "model_RF_deg_Mg_50C.rds")
loadRDS(file = "model_RF_deg_50C.rds")
```

```{r}
rm(model_gamma_deg_50C_pen_lasso, model_gamma_deg_Mg_50C_pen_lasso,
   model_gamma_deg_Mg_pH10_pen_lasso, model_gamma_deg_pH10_pen_lasso,
   model_gamma_reactivity_pen_lasso)
```

```{r}
models_RF_df <- data.frame(models_RF, errors_RF_train, errors_RF_val)
```

```{r}
models_RF_df
```

## Optimisation

### reactivity

### deg_Mg_pH10

### deg_pH10

### deg_Mg_50C

### deg_50C